<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_MainLayout}">
<head>
    <title layout:fragment="title">Pago</title>
</head>
<body>
<section layout:fragment="content">

<h2 th:text="'Pago - ' + ${#strings.capitalize(action)}"></h2>

<!-- FORMULARIO CREATE / EDIT -->
<form th:if="${action == 'create' or action == 'edit'}"
      th:action="@{'/pagos/' + ${action}}"
      th:object="${pago}" method="post">

    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" th:field="*{pagoId}"/>

    <!-- Reserva -->
    <div class="mb-3">
        <label>Reserva</label>
        <select id="reservaId" th:field="*{reservaId}" class="form-select" required>
            <option value="">Seleccione</option>
            <option th:each="r : ${reservas}" th:value="${r.reservaId}"
                    th:text="'ID: ' + ${r.reservaId} + ' | Cliente: ' + ${r.cliente.usuario.name} + ' | Paquete: ' + ${r.paquete.nombre}">
            </option>
        </select>
        <div th:if="${#fields.hasErrors('reservaId')}" th:errors="*{reservaId}" class="text-danger"></div>
    </div>

    <!-- Monto (solo lectura) -->
    <div class="mb-3">
        <label>Monto</label>
     <input type="text" id="monto" th:value="${pago.monto}" class="form-control" readonly/>
    </div>

    <!-- Método de pago -->
    <div class="mb-3">
        <label>Método de Pago</label>
        <select th:field="*{metodoPagoId}" class="form-select" required>
            <option value="">Seleccione</option>
            <option th:each="m : ${metodosPago}" th:value="${m.metodoPagoId}" th:text="${m.nombreMetodo}"></option>
        </select>
        <div th:if="${#fields.hasErrors('metodoPagoId')}" th:errors="*{metodoPagoId}" class="text-danger"></div>
    </div>

    <!-- Número de tarjeta -->
    <div class="mb-3">
        <label>Número de Tarjeta</label>
        <input type="text" th:field="*{numeroTarjeta}" class="form-control" placeholder="XXXX XXXX XXXX XXXX"/>
        <div th:if="${#fields.hasErrors('numeroTarjeta')}" th:errors="*{numeroTarjeta}" class="text-danger"></div>
    </div>

    <!-- Últimos 4 dígitos -->
    <div class="mb-3">
        <label>Últimos 4 dígitos</label>
        <input type="text" th:field="*{ultimos4Tarjeta}" class="form-control" readonly/>
    </div>

    <!-- Fecha de pago -->
    <div class="mb-3">
        <label>Fecha de Pago</label>
        <input type="text" th:field="*{fechaPago}" class="form-control" readonly/>
    </div>

    <!-- Estado del pago -->
    <div class="mb-3">
        <label>Estado</label>
        <input type="text" th:field="*{estadoPago}" class="form-control" readonly/>
    </div>

    <!-- Código de autorización -->
    <div class="mb-3">
        <label>Código de Autorización</label>
        <input type="text" th:field="*{codigoAutorizacion}" class="form-control" readonly/>
    </div>

    <!-- Botones -->
    <div class="d-flex gap-2 mt-3">
        <button type="submit" th:text="${action == 'create' ? 'Guardar' : 'Actualizar'}"
                th:classappend="${action == 'create' ? 'btn-primary' : 'btn-warning'}" class="btn"></button>
        <a th:href="@{/pagos}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

<!-- VIEW -->
<div th:if="${action == 'view'}" class="card p-4 mb-3">
    <h4>Detalle del Pago</h4>
    <hr/>
    <p><strong>Reserva:</strong> <span th:text="${pago.reserva?.reservaId}">---</span></p>
    <p><strong>Monto:</strong> <span th:text="${pago.monto}">---</span></p>
    <p><strong>Método de Pago:</strong> <span th:text="${pago.metodoPago?.nombreMetodo}">---</span></p>
    <p><strong>Fecha de Pago:</strong> <span th:text="${#temporals.format(pago.fechaPago,'yyyy-MM-dd HH:mm')}">---</span></p>
    <p><strong>Estado:</strong> <span th:text="${pago.estadoPago}">---</span></p>
    <p><strong>Código de Autorización:</strong> <span th:text="${pago.codigoAutorizacion}">---</span></p>
    <a th:href="@{/pagos}" class="btn btn-secondary mt-3">Volver</a>
</div>

<!-- DELETE -->
<form th:if="${action == 'delete'}" th:action="@{/pagos/delete}" th:object="${pago}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" th:field="*{pagoId}" />
    <p>¿Eliminar pago ID <strong th:text="${pago.pagoId}"></strong>?</p>
    <button type="submit" class="btn btn-danger">Eliminar</button>
    <a th:href="@{/pagos}" class="btn btn-secondary">Cancelar</a>
</form>

<!-- SCRIPT para llenar monto automáticamente -->
<script>
    const reservaSelect = document.getElementById('reservaId');
    const montoInput = document.getElementById('monto');

    reservaSelect.addEventListener('change', function() {
        const reservaId = this.value;
        if (!reservaId) {
            montoInput.value = '';
            return;
        }
        fetch(`/pagos/reserva/monto/${reservaId}`)
            .then(resp => resp.text())
            .then(data => montoInput.value = data)
            .catch(err => console.error('Error al obtener monto:', err));
    });

    // Cargar monto si ya hay reserva seleccionada (en edición)
    window.addEventListener('DOMContentLoaded', () => {
        if (reservaSelect.value) {
            reservaSelect.dispatchEvent(new Event('change'));
        }
    });
</script>

</section>
</body>
</html>
